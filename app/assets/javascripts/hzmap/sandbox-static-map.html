<!DOCTYPE html>
<html>
  <head>
    <style>
      #maps {
        width: 512px;
        height: 512px;
        background: #eee;
        position: absolute;
      }
      #map-image {
        position: absolute;
        z-index: 0;
        left: 0;
        top: 0;
      }
      #il-image {
        position: absolute;
        z-index: 1;
        top: 0;
        left: 0;
      }
      #qnmc-image {
        position: absolute;
        z-index: 2;
        top: 0;
        left: 0;
      }
      #qct-image {
        position: absolute;
        z-index: 3;
        top: 0;
        left: 0;
      }
      #marker {
        position: absolute;
        z-index: 4;
      }
    </style>
    <script type="text/javascript">
      
      function loadPage(){

        // // baltimore docks
        // var center = {
        //  lat: 39.26642, 
        //  lng: -76.57007
        // };
        // var zoom = 17;
        // var check = []

        // baltimore
        var center = {
         lat: 39.31916, 
         lng: -76.6165
        };
        var zoom = 12;
        var check = []

        // // usa
        // var center = {
        //  lat: 37.09024, 
        //  lng: -95.44922
        // };
        // var zoom = 5;

        // // earth
        // var center = {
        //  lat: 0, 
        //  lng: 0
        // };
        // var zoom = 2;

        // // // 4 corners
        // // var center = {
        // //  lat: 36.99871, 
        // //  lng: -109.04343
        // // };
        // // var zoom = 10;
        // // var check = []

        // // texas  multicolor
        // var center = {
        //   lat: 33.95020, 
        //   lng: -99.37134
        // };
        // var zoom = 8;
        // var check = []

        // // texas  downtown
        // var center = {
        //  lat: 33.90234, 
        //  lng: -98.48419
        // };
        // var zoom = 15;
        // var check = []

        var width = 512;
        var height = width;
        var scale = 1;

        var bbox = latLngToBbox(center.lat, center.lng, zoom, width, height, 256);
        console.log(bbox);

        document.getElementById('qnmc-image').src = buildWMSUrl({
          bbox: bbox.join(','),
          width: width*scale,
          height:height*scale,
          layer: 'qnmc'
        }); 

        document.getElementById('qct-image').src = buildWMSUrl({
          bbox: bbox.join(','),
          width: width*scale,
          height:height*scale,
          layer: 'qct'
        });

        document.getElementById('il-image').src = buildWMSUrl({
          bbox: bbox.join(','),
          width: width*scale,
          height:height*scale,
          layer: 'indian_lands'
        });

        document.getElementById('map-image').src = googleStatic({
          center: center,
          width: width,
          height: height,
          scale: scale,
          zoom: zoom  
        }); 

        addAddressesToMap(addresses, 'maps', bbox, height, width);
      };

      // ////////////////
      // coordinate converters
      // ////////////////

      function addAddressesToMap(addresses, mapsDiv, bbox, height, width){
        sw = toWGS84(bbox[0], bbox[1]);
        ne = toWGS84(bbox[2], bbox[3]);
        upperLeft = [sw[0], ne[1]];
        lat_range = ne[1] - sw[1];
        lng_range = ne[0] - sw[0];
        yscale = height / lat_range;
        xscale = width / lng_range;
        for (var i = 0; i < addresses.length; i++) {
          toOrigin = [addresses[i][1] - upperLeft[0], upperLeft[1] -  addresses[i][2]]
          toPixels = [parseInt(toOrigin[0] * xscale), parseInt(toOrigin[1] * yscale)]
          console.log(toPixels) 
          markersSvg = document.getElementById('marker');
          circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
          circle.setAttribute("cx",toPixels[0]);
          circle.setAttribute("cy",toPixels[1]);
          circle.setAttribute("r",5);
          markersSvg.appendChild(circle);
        }
      };

      function getTileNumber(lat, lng, zoom){
        var xtile, ytile;
        n = 2**zoom;
        xtile = (n * (lng+180.0)/360.0);
        lat_rad = Math.radians(lat);
        ytile = ((1.0 - Math.log(Math.tan(lat_rad) + Math.sec(lat_rad) ) / Math.PI) / 2.0 * n);
        return [xtile, ytile];
      }

      function tile2Lng(xtile, zoom){
        var n = 2 ** zoom;
        return xtile / n * 360.0 - 180.0;
      }

      function tile2Lat(ytile, zoom){
        var n = 2 ** zoom;
        return Math.degrees( Math.atan( Math.sinh( Math.PI * (1 - 2 * ytile / n) ) ) );
      }

      function latLngToBbox(lat, lng, zoom, width, height, tile_size){
        var xtile_w, xtile_e, ytile_s, ytile_n;
        var bbox = {};
        var tileNumbers = getTileNumber(lat, lng, zoom);
        var tileNumberX_fraction = 1*('0.' + tileNumbers[0].toString().split('.')[1]) || 0;
        var tileNumberY_fraction = 1*('0.' + tileNumbers[1].toString().split('.')[1]) || 0;
        xtile_w = (tileNumbers[0] * tile_size - (width/2)) / tile_size;
        xtile_e = (tileNumbers[0] * tile_size + (width/2)) / tile_size;
        ytile_s = (tileNumbers[1] * tile_size + (height/2)) / tile_size;
        ytile_n = (tileNumbers[1] * tile_size - (height/2)) / tile_size;
        bbox.w = tile2Lng(xtile_w, zoom);
        bbox.s = tile2Lat(ytile_s, zoom);
        bbox.e = tile2Lng(xtile_e, zoom);
        bbox.n = tile2Lat(ytile_n, zoom);
        webMSW = toWebMercator(bbox.w, bbox.s);
        webMNE = toWebMercator(bbox.e, bbox.n);
        console.log(webMSW, webMNE);
        // return [bbox.w, bbox.s, bbox.e, bbox.n];
        return [webMSW[0], webMSW[1], webMNE[0], webMNE[1]]  

      }

      // ////////////////
      // url builders
      // ////////////////

      function buildWMSUrl(options){
        var url = "http://localhost:8080/geoserver/hubzone-test/wms?service=WMS";
        url += "&REQUEST=GetMap";
        url += "&SERVICE=WMS";
        url += "&VERSION=1.1.0";
        url += "&LAYERS=hubzone-test:" + options.layer;
        url += "&FORMAT=image/png" ;
        url += "&TRANSPARENT=TRUE";
        // url += "&SRS=EPSG:4326";
        url += "&SRS=EPSG:900913";
        url += "&BBOX=" + options.bbox;
        url += "&WIDTH=" + options.width;
        url += "&HEIGHT=" + options.height;
        url += "&" + styles[options.layer];
        return url;
      };

      function googleStatic(options){
        var staticMap = "https://maps.googleapis.com/maps/api/staticmap"; 
        staticMap += "?center=" + options.center.lat + "," + options.center.lng; 
        staticMap += "&zoom=" + options.zoom;
        staticMap += "&size=" + options.width + "x" + options.height;
        staticMap += "&scale=" + options.scale;
        staticMap += "&maptype=roadmap";
        staticMap += "&key=";
        return staticMap;
      }

      // ////////////////
      // math helpers
      // ////////////////

      function toWebMercator(xLon, yLat){
        var semimajorAxis, xLon, yLat, east, north, northing;
        if ((Math.abs(xLon) > 180) && (Math.abs(yLat) > 90)){
          // coordinate out of range
          return;
        } else {
          semimajorAxis = 6378137.0;
          east = xLon * 0.017453292519943295;
          north = yLat * 0.017453292519943295;
          northing = 3189068.5 * Math.log((1.0 + Math.sin(north)) / (1.0 - Math.sin(north)))
          easting = semimajorAxis * east
          return [easting, northing];
        }
      }

      function toWGS84(xLon, yLat){
        var semimajorAxis, xLon, yLat, east, latitude, longitude;
        if ((Math.abs(xLon) < 180) && (Math.abs(yLat) > 90)){
          // coordinate out of range
          return;
        } else if ((Math.abs(xLon) > 20037508.3427892) || (Math.abs(yLat) > 20037508.3427892)){
          return;          
        } else {
          semimajorAxis = 6378137.0  
          latitude = (1.5707963267948966 - (2.0 * Math.atan(Math.exp((-1.0 * yLat) / semimajorAxis)))) * (180/Math.PI);
          longitude = ((xLon / semimajorAxis) * 57.295779513082323) - ((Math.floor((((xLon / semimajorAxis) * 57.295779513082323) + 180.0) / 360.0)) * 360.0);
          return [longitude, latitude];
        }
      };

      // secant
      Math.sec = function(aValue){
        return 1/Math.cos(aValue);
      }

      // Converts from degrees to radians.
      Math.radians = function(degrees) {
        return degrees * Math.PI / 180;
      };
       
      // Converts from radians to degrees.
      Math.degrees = function(radians) {
        return radians * 180 / Math.PI;
      };

      var styles = {
        indian_lands: "SLD_BODY=%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22UTF-8%22%3F%3E%3CStyledLayerDescriptor%20xmlns%3D%22http%3A%2F%2Fwww.opengis.net%2Fsld%22%20xmlns%3Aogc%3D%22http%3A%2F%2Fwww.opengis.net%2Fogc%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%20xmlns%3Axsi%3D%22http%3A%2F%2Fwww.w3.org%2F2001%2FXMLSchema-instance%22%20version%3D%221.0.0%22%20xsi%3AschemaLocation%3D%22http%3A%2F%2Fwww.opengis.net%2Fsld%20StyledLayerDescriptor.xsd%22%3E%3CNamedLayer%3E%3CName%3Ehubzone-test%3Aindian_lands%3C%2FName%3E%3CUserStyle%3E%3CFeatureTypeStyle%3E%3CRule%3E%3CName%3Enot%20expiring%3C%2FName%3E%3CPolygonSymbolizer%3E%3CFill%3E%3CCssParameter%20name%3D%22fill%22%3E%23984EA3%3C%2FCssParameter%3E%3CCssParameter%20name%3D%22fill-opacity%22%3E0.5%3C%2FCssParameter%3E%3C%2FFill%3E%3CStroke%3E%3CCssParameter%20name%3D%22stroke%22%3E%23984EA3%3C%2FCssParameter%3E%3CCssParameter%20name%3D%22stroke-width%22%3E1.25%3C%2FCssParameter%3E%3C%2FStroke%3E%3C%2FPolygonSymbolizer%3E%3C%2FRule%3E%3C%2FFeatureTypeStyle%3E%3C%2FUserStyle%3E%3C%2FNamedLayer%3E%3C%2FStyledLayerDescriptor%3E",
        qct: "SLD_BODY=%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22UTF-8%22%3F%3E%3CStyledLayerDescriptor%20xmlns%3D%22http%3A%2F%2Fwww.opengis.net%2Fsld%22%20xmlns%3Aogc%3D%22http%3A%2F%2Fwww.opengis.net%2Fogc%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%20xmlns%3Axsi%3D%22http%3A%2F%2Fwww.w3.org%2F2001%2FXMLSchema-instance%22%20version%3D%221.0.0%22%20xsi%3AschemaLocation%3D%22http%3A%2F%2Fwww.opengis.net%2Fsld%20StyledLayerDescriptor.xsd%22%3E%3CNamedLayer%3E%3CName%3Ehubzone-test%3Aqct%3C%2FName%3E%3CUserStyle%3E%3CFeatureTypeStyle%3E%3CRule%3E%3CName%3Enot%20expiring%3C%2FName%3E%3Cogc%3AFilter%3E%3Cogc%3APropertyIsEqualTo%3E%3Cogc%3AFunction%20name%3D%22isNull%22%3E%3Cogc%3APropertyName%3Eexpires%3C%2Fogc%3APropertyName%3E%3C%2Fogc%3AFunction%3E%3Cogc%3ALiteral%3Etrue%3C%2Fogc%3ALiteral%3E%3C%2Fogc%3APropertyIsEqualTo%3E%3C%2Fogc%3AFilter%3E%3CPolygonSymbolizer%3E%3CFill%3E%3CCssParameter%20name%3D%22fill%22%3E%234DAF4A%3C%2FCssParameter%3E%3CCssParameter%20name%3D%22fill-opacity%22%3E0.5%3C%2FCssParameter%3E%3C%2FFill%3E%3CStroke%3E%3CCssParameter%20name%3D%22stroke%22%3E%234DAF4A%3C%2FCssParameter%3E%3CCssParameter%20name%3D%22stroke-width%22%3E1.25%3C%2FCssParameter%3E%3C%2FStroke%3E%3C%2FPolygonSymbolizer%3E%3C%2FRule%3E%3CRule%3E%3CName%3Eexpiring%3C%2FName%3E%3Cogc%3AFilter%3E%3Cogc%3APropertyIsEqualTo%3E%3Cogc%3AFunction%20name%3D%22isNull%22%3E%3Cogc%3APropertyName%3Eexpires%3C%2Fogc%3APropertyName%3E%3C%2Fogc%3AFunction%3E%3Cogc%3ALiteral%3Efalse%3C%2Fogc%3ALiteral%3E%3C%2Fogc%3APropertyIsEqualTo%3E%3C%2Fogc%3AFilter%3E%3CPolygonSymbolizer%3E%3CFill%3E%3CGraphicFill%3E%3CGraphic%3E%3CMark%3E%3CWellKnownName%3Eshape%3A%2F%2Fbackslash%3C%2FWellKnownName%3E%3CStroke%3E%3CCssParameter%20name%3D%22stroke%22%3E%234DAF4A%3C%2FCssParameter%3E%3CCssParameter%20name%3D%22stroke-width%22%3E1.25%3C%2FCssParameter%3E%3C%2FStroke%3E%3C%2FMark%3E%3CSize%3E16%3C%2FSize%3E%3C%2FGraphic%3E%3C%2FGraphicFill%3E%3C%2FFill%3E%3CStroke%3E%3CCssParameter%20name%3D%22stroke%22%3E%234DAF4A%3C%2FCssParameter%3E%3CCssParameter%20name%3D%22stroke-width%22%3E1.25%3C%2FCssParameter%3E%3C%2FStroke%3E%3C%2FPolygonSymbolizer%3E%3C%2FRule%3E%3C%2FFeatureTypeStyle%3E%3C%2FUserStyle%3E%3C%2FNamedLayer%3E%3C%2FStyledLayerDescriptor%3E",
        qnmc: "SLD_BODY=%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22UTF-8%22%3F%3E%3CStyledLayerDescriptor%20xmlns%3D%22http%3A%2F%2Fwww.opengis.net%2Fsld%22%20xmlns%3Aogc%3D%22http%3A%2F%2Fwww.opengis.net%2Fogc%22%20xmlns%3Axlink%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxlink%22%20xmlns%3Axsi%3D%22http%3A%2F%2Fwww.w3.org%2F2001%2FXMLSchema-instance%22%20version%3D%221.0.0%22%20xsi%3AschemaLocation%3D%22http%3A%2F%2Fwww.opengis.net%2Fsld%20StyledLayerDescriptor.xsd%22%3E%3CNamedLayer%3E%3CName%3Ehubzone-test%3Aqnmc%3C%2FName%3E%3CUserStyle%3E%3CFeatureTypeStyle%3E%3CRule%3E%3CName%3Enot%20expiring%3C%2FName%3E%3Cogc%3AFilter%3E%3Cogc%3APropertyIsEqualTo%3E%3Cogc%3AFunction%20name%3D%22isNull%22%3E%3Cogc%3APropertyName%3Eexpires%3C%2Fogc%3APropertyName%3E%3C%2Fogc%3AFunction%3E%3Cogc%3ALiteral%3Etrue%3C%2Fogc%3ALiteral%3E%3C%2Fogc%3APropertyIsEqualTo%3E%3C%2Fogc%3AFilter%3E%3CPolygonSymbolizer%3E%3CFill%3E%3CCssParameter%20name%3D%22fill%22%3E%23377EB8%3C%2FCssParameter%3E%3CCssParameter%20name%3D%22fill-opacity%22%3E0.5%3C%2FCssParameter%3E%3C%2FFill%3E%3CStroke%3E%3CCssParameter%20name%3D%22stroke%22%3E%23377EB8%3C%2FCssParameter%3E%3CCssParameter%20name%3D%22stroke-width%22%3E1.25%3C%2FCssParameter%3E%3C%2FStroke%3E%3C%2FPolygonSymbolizer%3E%3C%2FRule%3E%3CRule%3E%3CName%3Eexpiring%3C%2FName%3E%3Cogc%3AFilter%3E%3Cogc%3APropertyIsEqualTo%3E%3Cogc%3AFunction%20name%3D%22isNull%22%3E%3Cogc%3APropertyName%3Eexpires%3C%2Fogc%3APropertyName%3E%3C%2Fogc%3AFunction%3E%3Cogc%3ALiteral%3Efalse%3C%2Fogc%3ALiteral%3E%3C%2Fogc%3APropertyIsEqualTo%3E%3C%2Fogc%3AFilter%3E%3CPolygonSymbolizer%3E%3CFill%3E%3CGraphicFill%3E%3CGraphic%3E%3CMark%3E%3CWellKnownName%3Eshape%3A%2F%2Fbackslash%3C%2FWellKnownName%3E%3CStroke%3E%3CCssParameter%20name%3D%22stroke%22%3E%23377EB8%3C%2FCssParameter%3E%3CCssParameter%20name%3D%22stroke-width%22%3E1.25%3C%2FCssParameter%3E%3C%2FStroke%3E%3C%2FMark%3E%3CSize%3E16%3C%2FSize%3E%3C%2FGraphic%3E%3C%2FGraphicFill%3E%3C%2FFill%3E%3CStroke%3E%3CCssParameter%20name%3D%22stroke%22%3E%23377EB8%3C%2FCssParameter%3E%3CCssParameter%20name%3D%22stroke-width%22%3E1.25%3C%2FCssParameter%3E%3C%2FStroke%3E%3C%2FPolygonSymbolizer%3E%3C%2FRule%3E%3C%2FFeatureTypeStyle%3E%3C%2FUserStyle%3E%3C%2FNamedLayer%3E%3C%2FStyledLayerDescriptor%3E"
      };      

      var addresses = [
        ["5200 Eastern Ave, BALTIMORE, MD, 21224",-76.553505,39.28721],
        ["2400 E Eager St, BALTIMORE, MD, 21205",-76.5834,39.30184],
        ["2200 Ruskin Ave, BALTIMORE, MD, 21217",-76.64816,39.31481],
        ["400 Homeland Ave, BALTIMORE, MD, 21212",-76.61484,39.353924],
        ["6600 Holabird Ave, BALTIMORE, MD, 21224",-76.53388,39.272453],
        ["700 Gladstone Ave, BALTIMORE, MD, 21210",-76.63152,39.354088],
        ["800 Exeter Hall Ave, BALTIMORE, MD, 21218",-76.60666,39.32265],
        ["100 E 28th St, BALTIMORE, MD, 21218",-76.61564,39.322018],
        ["5900 Belair Rd, BALTIMORE, MD, 21206",-76.54126,39.345413],
        ["1100 Horners Ln, BALTIMORE, MD, 21205",-76.55113,39.30497],
        ["1600 E Biddle St, BALTIMORE, MD, 21213",-76.59652,39.304256],
        ["2000 W Cold Spring Ln, BALTIMORE, MD, 21215",-76.64939,39.345085],
        ["2300 Calverton Heights Ave, BALTIMORE, MD, 21216",-76.6535,39.29777],
        ["1700 Broening Hwy, BALTIMORE, MD, 21224",-76.543434,39.27289],
        ["2700 St Paul St, BALTIMORE, MD, 21218",-76.61561,39.320778],
        ["2300 Eutaw Pl, BALTIMORE, MD, 21217",-76.6354,39.311863],
        ["3900 Springdale Ave, BALTIMORE, MD, 21207",-76.68449,39.32533],
        ["3500 Holmes Ave, BALTIMORE, MD, 21217",-76.65005,39.318745],
        ["900 Forrest St, BALTIMORE, MD, 21202",-76.60773,39.300144],
        ["7100 Supply Ave, BALTIMORE, MD, 21237",-76.53629,39.31224],
        ["5800 Kipling Ct, BALTIMORE, MD, 21212",-76.6058,39.36198],
        ["1300 Asbury Rd, BALTIMORE, MD, 21209",-76.64947,39.37066],
        ["1000 W 36th St, BALTIMORE, MD, 21211",-76.63274,39.331123],
        ["1900 Madison Ave, BALTIMORE, MD, 21217",-76.63291,39.307915],
        ["700 E 35th St, BALTIMORE, MD, 21218",-76.6063,39.33072],
        ["5500 Summerfield Ave, BALTIMORE, MD, 21206",-76.541695,39.333206],
        ["5300 Purlington Way, BALTIMORE, MD, 21212",-76.61775,39.359665],
        ["1800 N Pulaski St, BALTIMORE, MD, 21217",-76.65128,39.308743],
        ["5100 Linden Heights Ave, BALTIMORE, MD, 21215",-76.68169,39.342537],
        ["test",-76.58003,39.26180]
      ];
    </script>
  </head>
  <body onload="loadPage()">
  </body>
  <body onload="loadPage()">
      <div id="maps">
        <svg id="marker" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"></svg>
        <img id="qct-image"/>
        <img id="qnmc-image"/>
        <img id="il-image"/>
        <img id="map-image"/>
      </div>
  </body>

</html>
