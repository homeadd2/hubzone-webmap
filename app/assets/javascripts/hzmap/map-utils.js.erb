HZApp.MapUtils = (function(){
  return {
    // turn latlng object into url
    catchMapClick: function(clickEvent){
      var clicklng = clickEvent.latLng.lng();
      var clicklat = clickEvent.latLng.lat();
      var date = HZApp.MapUtils.parseDate(new Date());
      var locale = document.documentElement.lang || 'en';
      // Log the click
      HZApp.GA.track( 'map', 'click', clicklat + ',' + clicklng );
      var url = "<%= search_path %>?latlng=" + clicklat + ',' + clicklng + '&query_date=' + date + '&locale=' + locale;
      $.ajax({
        url: url
      });
      return url;
    },
    //helper to parse a javascript date because, why?
    parseDate: function(date){
      var mm = date.getMonth() + 1;
      var dd = date.getDate();
      return [date.getFullYear(),
              (mm>9 ? '' : '0') + mm,
              (dd>9 ? '' : '0') + dd
             ].join('-');
    },
    //jump to location on the map based on the geocode viewport object
    jumpToLocation: function(geocodeLocation){
      if (geocodeLocation.viewport){
        var newBounds = this.createGoogleLatLngBounds(
                          geocodeLocation.viewport.southwest.lng,
                          geocodeLocation.viewport.southwest.lat,
                          geocodeLocation.viewport.northeast.lng,
                          geocodeLocation.viewport.northeast.lat
          );
        HZApp.map.fitBounds(newBounds);
      }
    },
    createGoogleLatLngBounds: function(SWLng, SWLat, NELng, NELat){
      return new google.maps.LatLngBounds(
        new google.maps.LatLng(SWLat, SWLng),
        new google.maps.LatLng(NELat, NELng)
      );
    },

    // handling for showing the street view coverage layer
    streetViewLayer: {},
    toggleStreetViewLayer: function(){
      if (HZApp.MapUtils.streetViewLayer.getMap()){
        HZApp.MapUtils.streetViewLayer.setMap(null);
      } else {
        HZApp.MapUtils.streetViewLayer.setMap(HZApp.map);
      }
    },
    initializeStreetViewLayer: function(){
      HZApp.MapUtils.streetViewLayer = new google.maps.StreetViewCoverageLayer();
      var streetViewButton = document.getElementsByClassName("gm-svpc");
      for (var i = streetViewButton.length - 1; i >= 0; i--) {
        streetViewButton[i].addEventListener('click', HZApp.MapUtils.toggleStreetViewLayer);
      }
    }
  };
})();
